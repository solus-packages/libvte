From 36f943e0e214198ab9d84b3db10024e6af5ca424 Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@streambits.io>
Date: Thu, 19 Sep 2019 10:09:14 +0300
Subject: [PATCH 1/1] Revert "pty: Prefer using TIOCGPTPEER ioctl"

This reverts commit 118ad1caab2256bf731404c467c08b98e14b8ccc.
---
 src/pty.cc | 38 +++++++++++---------------------------
 1 file changed, 11 insertions(+), 27 deletions(-)

diff --git a/src/pty.cc b/src/pty.cc
index 6dd60345..f5e227fb 100644
--- a/src/pty.cc
+++ b/src/pty.cc
@@ -33,7 +33,6 @@
 #include "vtetypes.hh"
 #include "vtespawn.hh"
 
-#include <assert.h>
 #include <sys/types.h>
 #include <sys/ioctl.h>
 #include <sys/socket.h>
@@ -160,39 +159,24 @@ vte_pty_child_setup (VtePty *pty)
         }
 
         /* Note: *not* O_CLOEXEC! */
-        auto const fd_flags = int{O_RDWR | ((priv->flags & VTE_PTY_NO_CTTY) ? O_NOCTTY : 0)};
-        auto fd = int{-1};
+        auto const fd_flags = O_RDWR | ((priv->flags & VTE_PTY_NO_CTTY) ? O_NOCTTY : 0);
 
-#ifdef __linux__
-        fd = ioctl(masterfd, TIOCGPTPEER, fd_flags);
-        if (fd == -1 && errno != EINVAL) {
-		_vte_debug_print(VTE_DEBUG_PTY, "%s failed: %m\n", "ioctl(TIOCGPTPEER)");
+	char *name = ptsname(masterfd);
+        if (name == nullptr) {
+		_vte_debug_print(VTE_DEBUG_PTY, "%s failed: %m\n", "ptsname");
 		_exit(127);
-        }
+	}
 
-        /* EINVAL means the kernel doesn't support this ioctl; fall back to ptsname + open */
-#endif
+        _vte_debug_print (VTE_DEBUG_PTY,
+                          "Setting up child pty: master FD = %d name = %s\n",
+                          masterfd, name);
 
+        int fd = open(name, fd_flags);
         if (fd == -1) {
-                auto const name = ptsname(masterfd);
-                if (name == nullptr) {
-                        _vte_debug_print(VTE_DEBUG_PTY, "%s failed: %m\n", "ptsname");
-                        _exit(127);
-                }
-
-                _vte_debug_print (VTE_DEBUG_PTY,
-                                  "Setting up child pty: master FD = %d name = %s\n",
-                                  masterfd, name);
-
-                fd = open(name, fd_flags);
-                if (fd == -1) {
-                        _vte_debug_print (VTE_DEBUG_PTY, "Failed to open PTY: %m\n");
-                        _exit(127);
-                }
+                _vte_debug_print (VTE_DEBUG_PTY, "Failed to open PTY: %m\n");
+                _exit(127);
         }
 
-        assert(fd != -1);
-
 #if defined(HAVE_SETSID) && defined(HAVE_SETPGID)
         if (!(priv->flags & VTE_PTY_NO_SESSION)) {
                 /* Start a new session and become process-group leader. */
-- 
2.23.0

